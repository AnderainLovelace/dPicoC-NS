#include "interpreter.h"
#include "picoc.h"

#define COLOR_BLACK		(0)
#define COLOR_WHITE		(lcd_type ? 0xFFFF : 0xF)

#define	PICOC_STACK_SIZE			(100*1024)
#define	DPICOC_TITLE_TEXT			"dPicoC v2.1n - Select a c-file"
#define DPICOC_TITLE_PROJECT		"dPicoC v2.1n - Select a project"
#define DPICOC_TITLE_SCRIPT			"dPicoC v2.1n - Select a script"
#define DPICOC_FILE_PATH			"/documents/dpicoc"

// browse.c
extern BOOL file_browse (const char * path,const char * filter,const char * title,char * filename);

// chardisp.c
extern void write_graph(int x,int y,int width,int height,unsigned char * pimage,int cl_fg,int cl_bg);
extern int get_string (int x,int y,char * s,int width,int max,BOOL only_num,int clf,int clb);
extern const unsigned char title_graph[];

// load config file
#define CFG_LCD_GRAY	0
#define CFG_LCD_COLOR	1
#define CFG_FILE_NAME	"/documents/dpicoc/dpicoc.cfg.tns"


unsigned int	stack_size;
int				lcd_type;

void load_config()
{
	FILE *		fp;
	
	fp = fopen (CFG_FILE_NAME,"rb");

	if (fp==NULL)
	{
		fp = fopen(CFG_FILE_NAME,"wb");
		lcd_type 	= CFG_LCD_GRAY;			fwrite(&lcd_type  ,sizeof(int),1,fp);
		stack_size	= PICOC_STACK_SIZE;		fwrite(&stack_size,sizeof(int),1,fp);
	}
	else
	{
		fread(&lcd_type  ,sizeof(int),1,fp);
		fread(&stack_size,sizeof(int),1,fp);
		if (lcd_type != CFG_LCD_GRAY && lcd_type != CFG_LCD_COLOR)	lcd_type	= CFG_LCD_GRAY;
		if (lcd_type == CFG_LCD_COLOR && !has_colors)				lcd_type	= CFG_LCD_GRAY;
		if (stack_size<=0)											stack_size	= PICOC_STACK_SIZE;
	}
	fclose(fp);
}

int select_mode ()
{
	BOOL		refresh = TRUE;
	static int	index = 0;
	const int	itemmax = 5;
	char		itemtext[][16] = {"Standard C","Script","Project","Config dPicoC","Exit"};
	clrscr();
	write_graph((320-112)/2,8,112,39,title_graph,COLOR_BLACK,COLOR_WHITE);
	
	while (TRUE)
	{
		if (refresh)
		{
			refresh = FALSE;
			int top = 64,i,left;
			for (i=0;i<itemmax;++i,top+=16)
			{
				left = 160-4*strlen(itemtext[i]);
				if (index!=i)
					dg_put_str(left,top,itemtext[i],COLOR_WHITE,COLOR_BLACK);
				else
					dg_put_str(left,top,itemtext[i],COLOR_BLACK,COLOR_WHITE);
			}
		}
		wait_key_pressed ();
		if (isKeyPressed(KEY_NSPIRE_UP)) 
			{if(--index<0) index = itemmax - 1;refresh = TRUE;}
		else if (isKeyPressed(KEY_NSPIRE_DOWN)) 
			{if(++index>itemmax - 1) index = 0;refresh = TRUE;}
		else if (isKeyPressed(KEY_NSPIRE_ENTER))	return index;
		else if (isKeyPressed(KEY_NSPIRE_ESC))		return -1;
	}
}

int main()
{
	char 	file_name[128];
	FILE*	project_file 	= NULL;
	BOOL	script_mode		= FALSE;
	BOOL 	project_mode	= FALSE;
	BOOL 	start_run		= FALSE;
	// check version
	assert_ndless_rev(695);
	// load user config
	load_config();
	// select lcd mode
	switch (lcd_type)
	{
		default:
		case CFG_LCD_GRAY  : lcd_ingray (); break;
		case CFG_LCD_COLOR : lcd_incolor(); break;
	}
	// selecy run mode
	while (!start_run)
	{
		script_mode	 = FALSE;
		project_mode = FALSE;
		switch (select_mode())
		{
			case 0://standard
				start_run = file_browse(DPICOC_FILE_PATH,".c.tns",DPICOC_TITLE_TEXT,file_name);
				break;
			case 1:// script
				script_mode = TRUE;
				start_run = file_browse(DPICOC_FILE_PATH,".c.tns",DPICOC_TITLE_SCRIPT,file_name);
				break;
			case 2://project
				project_mode = TRUE;
				start_run = file_browse(DPICOC_FILE_PATH,".cpj.tns",DPICOC_TITLE_PROJECT,file_name);
				break;
			case 3://config mode
			{
				int   r,left;
				char  buf[128];
				extern long utils_atol(char *nptr);
				
				clrscr();
				dg_put_str(0,0,"LCD initial mode:(color/gray)",COLOR_WHITE,COLOR_BLACK);
				strcpy(buf,lcd_type ? "color":"gray");
				get_string(0,12,buf,12,128,FALSE,COLOR_BLACK,COLOR_WHITE);
				if (strcmp(buf,"color")==0)		lcd_type = CFG_LCD_COLOR;
				else							lcd_type = CFG_LCD_GRAY;
				
				dg_put_str(0,24,"Stack size(bytes):",COLOR_WHITE,COLOR_BLACK);
				sprintf(buf,"%d",stack_size);
				get_string(0,36,buf,12,128,TRUE,COLOR_BLACK,COLOR_WHITE);
				stack_size = utils_atol(buf);
				if (stack_size<=0) stack_size = PICOC_STACK_SIZE;
				
				FILE * fp = fopen(CFG_FILE_NAME,"wb");
				fwrite(&lcd_type  ,sizeof(int),1,fp);
				fwrite(&stack_size,sizeof(int),1,fp);
				fclose(fp);
				
				clrscr();
				dg_put_str(0,0,"config saved,please restart",COLOR_WHITE,COLOR_BLACK);
				sleep(100);
				wait_key_pressed();
				return 0;
			}
				break;
			case 4: //exit
			case -1:
			default:return 0;
		}
	}
	
	PicocInitialise(stack_size);
	
	clrscr();
	dConsoleInit ();
	dConsoleRefresh();
	
	if (PicocPlatformSetExitPoint())
 	{
		wait_key_pressed();
		if (project_file!=NULL)
			fclose(project_file);
		dConsoleCleanUp	();
 		PicocCleanup();
 		return -1;
		
 	}
	
	if (script_mode)
		PicocIncludeAllSystemHeaders();

	if (project_mode)
	{
		char	line[128],*p;
		project_file = fopen(file_name,"r");
		while(!feof(project_file))
		{
			fgets(line,128,project_file);
			if (p=strchr(line,'\n'))*p = '\0';
			PicocPlatformScanFile(line);
		}
		fclose(project_file);
	}
	else
		PicocPlatformScanFile(file_name);

 	if (!script_mode)
		PicocCallMain(0,0);
    
	dConsolePut("Press any key to continue");
	wait_key_pressed();
	
	PicocCleanup();
	dConsoleCleanUp();
	
    return 0;
}
const unsigned char title_graph[] = //112*39
{0x0,0x0,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xF,0xFC,0x0,
0x0,0x0,0x7,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x78,0x7,0x78,
0x0,0x0,0x7,0x0,0x0,0x0,0x1E,0x0,0x0,0x0,0x1,0xC0,0x1,0xC8,
0x0,0x0,0x7,0x0,0x0,0x0,0x33,0x0,0x0,0x0,0x3,0x3,0xF0,0x8,
0x0,0x0,0xE,0x3,0xFF,0xF8,0x21,0x0,0x0,0x0,0x6,0xF,0xF8,0x8,
0x0,0x0,0xE,0x2,0x0,0xE,0x21,0x0,0x0,0x0,0xC,0x1E,0xC,0x8,
0x0,0x0,0xE,0x3,0x87,0xC3,0x33,0x0,0x0,0x0,0x18,0x38,0x6,0x8,
0x0,0x0,0xC,0x0,0xC7,0xF1,0x9F,0x0,0x0,0x0,0x10,0x70,0x3,0x8,
0x0,0x0,0x1C,0x0,0x44,0x10,0x86,0x0,0x0,0x0,0x30,0x60,0x1,0x8,
0x0,0x7,0x1C,0x0,0x44,0x18,0x80,0x0,0x0,0x0,0x20,0xC0,0x1,0x88,
0x0,0x1F,0x98,0x0,0x44,0x8,0x9F,0x1,0xFC,0x3,0xF8,0xC0,0x0,0x88,
0x0,0x3B,0xB8,0x0,0x44,0x8,0xF1,0x7,0x7,0xE,0xE,0x80,0x0,0x88,
0x0,0xF1,0xB8,0x0,0x44,0x18,0x81,0xC,0xF1,0x98,0xF3,0x80,0x0,0xC8,
0x1,0xE1,0xB0,0x0,0x44,0x11,0xE1,0x19,0xF0,0xB3,0xF9,0x80,0x0,0x48,
0x1,0xC1,0xF0,0x0,0x44,0x73,0xB1,0x11,0x90,0xA3,0x88,0x80,0x0,0x78,
0x3,0x81,0xF0,0x1,0x47,0xC7,0x11,0x33,0x10,0xE6,0x8C,0xC0,0x0,0x18,
0x7,0x1,0xF0,0x3,0x40,0x1E,0x11,0x23,0x19,0xC6,0x84,0x40,0x0,0x0,
0xE,0x1,0xE0,0x6,0x47,0xFC,0x11,0x22,0xF,0xC4,0x84,0x40,0x0,0x0,
0xC,0x3,0x60,0x1C,0x47,0xF0,0x11,0x22,0x3,0x44,0x84,0x40,0x0,0x0,
0x1C,0x7,0x60,0x38,0x44,0x0,0x11,0x22,0x0,0x44,0x84,0x40,0x0,0x0,
0x38,0xE,0x60,0x70,0x44,0x0,0x11,0x22,0x0,0x44,0x84,0x40,0x0,0x0,
0x30,0x1C,0x61,0xE0,0x44,0x0,0x11,0x23,0x1,0xC4,0x84,0x40,0x0,0x0,
0x70,0x38,0x67,0x80,0x44,0x0,0x11,0x31,0x83,0x66,0x8C,0xC0,0x0,0x0,
0x70,0xF0,0x7F,0x0,0x44,0x0,0x11,0x10,0xCE,0x62,0x88,0xC0,0x0,0x0,
0x61,0xC0,0x3E,0x0,0xC6,0x0,0x11,0x98,0x78,0xF3,0xF9,0x80,0x0,0x0,
0x7F,0x80,0x18,0x3,0x83,0x80,0x70,0xCC,0x1,0xD8,0xE3,0xC0,0x0,0x38,
0x7F,0x0,0x0,0x2,0x0,0x80,0x40,0x46,0x7,0x8E,0xF,0x40,0x0,0x6C,
0x78,0x0,0x0,0x3,0xFF,0x80,0x7F,0xC3,0xFF,0x3,0xFE,0x60,0x0,0x44,
0x0,0x0,0x0,0x0,0xFF,0x80,0x1F,0xC0,0xFC,0x0,0xF8,0x30,0x0,0xCC,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x30,0x10,0x1,0x8C,
0x0,0x0,0x0,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x18,0x1C,0x3,0x18,
0x0,0x0,0x0,0x4,0x4,0x8,0x0,0x0,0x8,0x0,0xC,0x7,0xE,0x38,
0x1,0x9E,0x6,0xF4,0xC5,0xFC,0xCD,0xCC,0xDC,0xCC,0x6,0x1,0xF8,0x70,
0x2,0x52,0x8,0x15,0x5,0x29,0x29,0x29,0x29,0x28,0x3,0x0,0x0,0xE0,
0x2,0x52,0xC8,0x75,0x5,0x29,0xE9,0x29,0xE9,0xE8,0x1,0xC0,0x1,0xC0,
0x2,0x52,0x8,0x95,0x5,0x29,0x9,0x29,0x9,0x8,0x0,0x70,0xF,0x80,
0x1,0x92,0x6,0xF4,0xC5,0x2C,0xE9,0xC8,0xEC,0xE8,0x0,0x1F,0xFF,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x7,0xF8,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,};
long utils_atol(char *nptr)
{
    int c;          /* current char */
    long total;     /* current total */
    int sign;       /* if '-', then negative, otherwise positive */

    /* skip whitespace */
    while ( isspace((int)(unsigned char)*nptr) )
        ++nptr;

    c = (int)(unsigned char)*nptr++;
    sign = c;       /* save sign indication */
    if (c == '-' || c == '+')
        c = (int)(unsigned char)*nptr++;    /* skip sign */

    total = 0;

    while (isdigit(c)) {
        total = 10 * total + (c - '0');     /* accumulate digit */
        c = (int)(unsigned char)*nptr++;    /* get next char */
    }

    if (sign == '-')
        return -total;
    else
        return total;   /* return result, negated if necessary */
}